<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Компас Киблы</title>
<style>
  :root{
    /* Палитра из первого варианта */
    --bg1:#2e3a87; --bg2:#7386ff;
    --dial:#f7fbff; --ring:#142352; --tick:#cfd6ff;
    --text:#ffffff; --muted:#c7d0ff;
    --accent:#f9c846; --accent2:#f2b22c; --ok:#00d08a;
    --needleBody:#1f2a66; --needleTip:#ffcc33;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
    color:var(--text);
    background: radial-gradient(120% 120% at 50% -10%, var(--bg2), var(--bg1));
    display:flex; flex-direction:column; align-items:center;
  }

  header{width:100%;max-width:560px; text-align:center; padding:18px 16px 8px}
  h1{margin:0 0 10px; font-size:22px; letter-spacing:.2px}
  #startBtn{
    border:0; cursor:pointer; outline:0;
    padding:12px 28px; border-radius:999px;
    font-weight:800; font-size:18px; color:#3a2a00;
    background:linear-gradient(180deg, var(--accent) 0%, var(--accent2) 100%);
    box-shadow:0 10px 22px rgba(0,0,0,.32);
  }
  #startBtn[disabled]{opacity:.7; cursor:default}
  #status{margin-top:10px; font-size:13px; color:var(--muted); min-height:1.2em}

  .dial-wrap{position:relative; width:min(90vw,520px); aspect-ratio:1; margin:16px auto 6px}
  /* Слои циферблата */
  .rim{
    position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(60% 60% at 50% 45%, #3a4aa1 0 30%, #1e295c 70%);
    box-shadow: inset 0 0 60px rgba(0,0,0,.35), 0 18px 40px rgba(0,0,0,.38);
    z-index:1;
  }
  .face{
    position:absolute; inset:4.5%; border-radius:50%;
    background: radial-gradient(90% 90% at 50% 45%, var(--dial) 0%, #e9eefc 70%, #d8e0fb 100%);
    box-shadow: inset 0 8px 30px rgba(0,0,0,.12);
    z-index:2;
  }
  .ring{
    position:absolute; inset:11.5%; border-radius:50%;
    border:12px solid rgba(20,35,82,.12);
    z-index:2;
  }

  /* Деления */
  .hashes{position:absolute; inset:12.5%; border-radius:50%; z-index:3; pointer-events:none;}
  .tick{
    position:absolute; left:50%; top:50%;
    width:2px; height:13%;
    background:var(--tick);
    transform-origin:50% 0%;
    opacity:.95;
  }
  .tick.major{width:4px; height:15%; background:#9fb0ff}

  /* NSEW — над всем, с «плашкой» под каждой буквой, чтобы кольца не заезжали визуально */
  .cardinals{position:absolute; inset:0; z-index:4; pointer-events:none;}
  .cardinals .lbl{
    position:absolute; left:50%; top:50%;
    transform:translate(-50%,-50%);
    font-weight:900; letter-spacing:.5px;
    color:#0a1b4d;
    text-shadow:0 1px 0 #fff8, 0 0 12px #fff8;
    padding:4px 8px; border-radius:10px;
    background:rgba(255,255,255,.65);
    border:1px solid rgba(14,24,60,.1);
  }
  .cardinals .N{top:5.5%;  font-size:20px}
  .cardinals .S{top:94.5%; font-size:18px}
  .cardinals .E{left:94.5%; font-size:18px}
  .cardinals .W{left:5.5%;  font-size:18px}

  /* Игла */
  .needle{position:absolute; left:50%; top:50%;
          transform:translate(-50%,-50%) rotate(0deg);
          transform-origin:50% 80%;
          width:64%; height:64%; pointer-events:none; z-index:5;}
  .needle .tip{
    position:absolute; left:50%; top:2%;
    transform:translateX(-50%);
    width:0; height:0; border-left:18px solid transparent; border-right:18px solid transparent;
    border-bottom:30px solid var(--needleTip);
    filter: drop-shadow(0 4px 6px rgba(0,0,0,.25));
  }
  .needle .shaft{
    position:absolute; left:50%; top:8%;
    transform:translateX(-50%);
    width:10px; height:60%;
    background:linear-gradient(180deg, #2c3a86, #172055);
    border-radius:10px;
    box-shadow: 0 6px 18px rgba(0,0,0,.25);
  }
  .needle .hub{
    position:absolute; left:50%; top:76%; transform:translate(-50%,-50%);
    width:56px; height:56px; border-radius:50%;
    background: radial-gradient(circle at 35% 35%, #ffe38f 0 40%, #f8b52c 70%);
    box-shadow: inset 0 -8px 14px rgba(0,0,0,.15), 0 8px 18px rgba(0,0,0,.22);
    border:3px solid #fff;
  }

  /* Маркер Каабы */
  .kaaba{
    position:absolute; left:50%; top:12%;
    transform:translate(-50%,-50%);
    width:48px; height:48px; border-radius:10px;
    background:
      linear-gradient(135deg, #2b2b2b 63%, #ffd23c 63%) no-repeat,
      linear-gradient(#111, #333);
    box-shadow: 0 10px 20px rgba(0,0,0,.35);
    z-index:4;
  }

  .caption{margin-top:8px; text-align:center; line-height:1.35}
  .hint{font-size:14px; color:var(--muted)}
  .ok{color:var(--ok); font-weight:800}

  .panel{
    margin-top:10px; padding:10px 14px; border-radius:12px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    font-size:13px; text-align:center; backdrop-filter: blur(6px);
    max-width:min(92vw,560px);
  }
  .panel b{color:#ffe38f}
  footer{margin-top:auto; padding:16px; font-size:12px; color:var(--muted); text-align:center}
</style>
</head>
<body>
  <header>
    <h1>Компас Киблы</h1>
    <button id="startBtn">Start</button>
    <div id="status"></div>
  </header>

  <div class="dial-wrap" aria-label="Компас">
    <div class="rim"></div>
    <div class="face"></div>
    <div class="ring"></div>

    <div class="hashes" id="hashes"></div>

    <div class="cardinals" aria-hidden="true">
      <div class="lbl N">N</div>
      <div class="lbl E">E</div>
      <div class="lbl S">S</div>
      <div class="lbl W">W</div>
    </div>

    <div id="needle" class="needle" aria-hidden="true">
      <div class="tip"></div>
      <div class="shaft"></div>
      <div class="hub"></div>
    </div>

    <div class="kaaba" title="Кибла"></div>
  </div>

  <div class="caption">
    <div id="msgMain">Нажмите <b>Start</b> и разрешите доступ к геопозиции и ориентации</div>
    <div class="hint">Держите устройство параллельно земле</div>
  </div>

  <div class="panel" id="readout" hidden>
    Азимут на Киблу: <b id="brng">—°</b> • Ваш курс: <b id="head">—°</b>
  </div>

  <footer>Если стрелка не двигается — у устройства нет компаса или браузер запретил датчики. На iOS подтвердите «Доступ к движению и ориентации».</footer>

<script>
(function () {
  const EL = s => document.querySelector(s);
  const statusEl = EL('#status');
  const msgMain  = EL('#msgMain');
  const startBtn = EL('#startBtn');
  const needle   = EL('#needle');
  const readout  = EL('#readout');
  const brngEl   = EL('#brng');
  const headEl   = EL('#head');

  // Сгенерировать деления
  const hashes = document.getElementById('hashes');
  for (let i=0;i<36;i++){ // каждые 10°
    const d = document.createElement('div');
    d.className = 'tick';
    if (i%9===0) d.classList.add('major'); // 0,90,180,270
    d.style.transform = `translate(-50%,-50%) rotate(${i*10}deg) translateY(-43%)`;
    hashes.appendChild(d);
  }

  // Координаты Каабы
  const KAABA = { lat: 21.422487, lon: 39.826206 };

  let user = { lat: null, lon: null };
  let qiblaBearing = null;  // истинный азимут на Киблу (0..360)
  let lastHeading = null;   // курс устройства (0..360)

  const toRad = d => d * Math.PI / 180;
  const toDeg = r => r * 180 / Math.PI;
  const norm  = a => (a%360+360)%360;

  function bearingTo(lat1, lon1, lat2, lon2) {
    const φ1 = toRad(lat1), φ2 = toRad(lat2), Δλ = toRad(lon2 - lon1);
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    return norm(toDeg(Math.atan2(y, x)));
  }

  function updateNeedle(){
    if (qiblaBearing==null || lastHeading==null) return;
    const rel = norm(qiblaBearing - lastHeading); // сколько повернуть иглу
    needle.style.transform = `translate(-50%,-50%) rotate(${rel}deg)`;
    brngEl.textContent = `${Math.round(qiblaBearing)}°`;
    headEl.textContent = `${Math.round(lastHeading)}°`;
    readout.hidden = false;

    const diff = Math.min(rel, 360-rel);
    if (diff < 8) {
      msgMain.innerHTML = '<span class="ok">Вы нашли Киблу</span><br/><span style="opacity:.9">You\'ve found Qibla</span>';
    } else if (diff < 20) {
      msgMain.innerHTML = 'Почти у цели<br/><span style="opacity:.9">Almost there</span>';
    } else {
      msgMain.textContent = 'Вращайте устройство, пока стрелка не совпадёт с меткой';
    }
  }

  // Геолокация
  function askGeolocation() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) {
        statusEl.textContent = 'Геолокация недоступна в браузере';
        return resolve(false);
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          user.lat = pos.coords.latitude;
          user.lon = pos.coords.longitude;
          qiblaBearing = bearingTo(user.lat, user.lon, KAABA.lat, KAABA.lon);
          statusEl.textContent = `Гео: ${user.lat.toFixed(4)}, ${user.lon.toFixed(4)} • Азимут: ${Math.round(qiblaBearing)}°`;
          updateNeedle();
          resolve(true);
        },
        err => {
          statusEl.textContent = 'Не удалось получить геопозицию: ' + err.message;
          resolve(false);
        },
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }

  // Датчики ориентации
  function subscribeOrientation() {
    return new Promise((resolve) => {
      function onOrient(e) {
        let heading = null;
        if (typeof e.webkitCompassHeading === 'number') {
          // iOS Safari / WebView отдаёт истинный курс
          heading = e.webkitCompassHeading;
        } else if (typeof e.alpha === 'number') {
          // Android Chrome: приблизительно => обратим, чтобы 0 = север
          heading = 360 - e.alpha;
        }
        if (heading != null) {
          lastHeading = norm(heading);
          updateNeedle();
        }
      }

      if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
        // iOS: запрашиваем явное разрешение ТОЛЬКО по клику
        DeviceOrientationEvent.requestPermission()
          .then(state => {
            if (state === 'granted') {
              window.addEventListener('deviceorientation', onOrient, true);
              statusEl.textContent += ' • Ориентация: OK';
              resolve(true);
            } else {
              statusEl.textContent += ' • Ориентация: отклонено';
              resolve(false);
            }
          })
          .catch(err => { statusEl.textContent += ' • Ошибка ориентации: ' + err; resolve(false); });
      } else if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', onOrient, true);
        statusEl.textContent += ' • Ориентация: OK';
        resolve(true);
      } else {
        statusEl.textContent += ' • Датчик ориентации недоступен';
        resolve(false);
      }
    });
  }

  // Кнопка Start — строго по пользовательскому клику
  startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    startBtn.textContent = '…';
    msgMain.textContent = 'Запрашиваю разрешения…';

    const geoOk = await askGeolocation();
    const oriOk = await subscribeOrientation();

    if (!geoOk && !oriOk) {
      msgMain.textContent = 'Нет доступа к геопозиции и ориентации устройства.';
      startBtn.disabled = false;
      startBtn.textContent = 'Start';
      return;
    }

    if (geoOk && !oriOk) {
      msgMain.textContent = 'Ориентация недоступна. Стрелка может не вращаться.';
    } else if (!geoOk && oriOk) {
      msgMain.textContent = 'Геопозиция недоступна. Укажите позицию вручную (в приложении бота).';
    } else {
      msgMain.textContent = 'Вращайте устройство, пока стрелка не совпадёт с меткой';
    }
  });
})();
</script>
</body>
</html>

