<script>
// Координаты Каабы
const KAABA_LAT = 21.422487;
const KAABA_LON = 39.826206;

// Расчёт угла Киблы
function getQiblaAngle(lat, lon) {
    const φ1 = lat * Math.PI/180;
    const φ2 = KAABA_LAT * Math.PI/180;
    const Δλ = (KAABA_LON - lon) * Math.PI/180;

    const y = Math.sin(Δλ);
    const x = Math.cos(φ1)*Math.tan(φ2) - Math.sin(φ1)*Math.cos(Δλ);
    let θ = Math.atan2(y, x);

    θ = (θ * 180/Math.PI + 360) % 360;
    return θ;
}

// UI
const arrow = document.getElementById("arrow");

// Запрос координат
navigator.geolocation.getCurrentPosition(async pos => {
    const userLat = pos.coords.latitude;
    const userLon = pos.coords.longitude;

    const qiblaAngle = getQiblaAngle(userLat, userLon);

    initCompass(qiblaAngle);
}, err => {
    alert("Разрешите доступ к геолокации!");
});

// Инициализация компаса
async function initCompass(qiblaAngle) {

    // ───── iOS: нужно разрешение ─────
    if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === "function") {
        const permission = await DeviceOrientationEvent.requestPermission().catch(() => null);
        if (permission !== "granted") {
            alert("Разрешите доступ к датчикам ориентации для работы компаса.");
            return;
        }
    }

    // ───── Попытка через AbsoluteOrientationSensor ─────
    if ("AbsoluteOrientationSensor" in window) {
        try {
            const sensor = new AbsoluteOrientationSensor({ frequency: 60 });
            sensor.addEventListener("reading", () => {
                const q = sensor.quaternion;
                const yaw = Math.atan2(2*(q[0]*q[3] + q[1]*q[2]), 1 - 2*(q[2]*q[2] + q[3]*q[3]));
                const heading = (yaw * -180 / Math.PI + 360) % 360;

                updateArrow(heading, qiblaAngle);
            });
            sensor.start();
            return;
        } catch (e) {
            console.warn("AbsoluteOrientationSensor error:", e);
        }
    }

    // ───── Fallback: DeviceOrientationEvent ─────
    window.addEventListener("deviceorientation", event => {
        if (event.webkitCompassHeading) {
            updateArrow(event.webkitCompassHeading, qiblaAngle); // iOS
        } else if (event.alpha !== null) {
            updateArrow(360 - event.alpha, qiblaAngle); // Android
        }
    });
}

// Поворот стрелки
function updateArrow(heading, qiblaAngle) {
    const rotation = (qiblaAngle - heading + 360) % 360;
    arrow.style.transform = `rotate(${rotation}deg)`;
}
</script>
