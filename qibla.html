<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Компас Киблы</title>
<style>
  :root{
    --bg1:#2e3a87; --bg2:#7386ff;
    --dial:#f7fbff; --ring:#142352; --tick:#cfd6ff;
    --text:#ffffff; --muted:#c7d0ff;
    --accent:#f9c846; --accent2:#f2b22c; --ok:#00d08a;
    --gold1:#ffe38f; --gold2:#f8b52c; --gold3:#ffcc33;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;
    color:var(--text);
    background: radial-gradient(120% 120% at 50% -10%, var(--bg2), var(--bg1));
    display:flex; flex-direction:column; align-items:center;
  }
  header{width:100%;max-width:560px; text-align:center; padding:18px 16px 8px}
  h1{margin:0 0 10px; font-size:22px; letter-spacing:.2px}
  .btn{
    border:0; cursor:pointer; outline:0;
    padding:12px 28px; border-radius:999px;
    font-weight:800; font-size:18px; color:#3a2a00;
    background:linear-gradient(180deg, var(--accent) 0%, var(--accent2) 100%);
    box-shadow:0 10px 22px rgba(0,0,0,.32);
  }
  .btn[disabled]{opacity:.7; cursor:default}
  #startBtn{display:inline-block}
  #enableMotionBtn{display:none; margin-left:8px}
  #status{margin-top:10px; font-size:13px; color:var(--muted); min-height:1.2em}

  .dial-wrap{position:relative; width:min(90vw,520px); aspect-ratio:1; margin:16px auto 6px}
  .rim{position:absolute; inset:0; border-radius:50%;
    background: radial-gradient(60% 60% at 50% 45%, #3a4aa1 0 30%, #1e295c 70%);
    box-shadow: inset 0 0 60px rgba(0,0,0,.35), 0 18px 40px rgba(0,0,0,.38); z-index:1;}
  .face{position:absolute; inset:4.5%; border-radius:50%;
    background: radial-gradient(90% 90% at 50% 45%, var(--dial) 0%, #e9eefc 70%, #d8e0fb 100%);
    box-shadow: inset 0 8px 30px rgba(0,0,0,.12); z-index:2;}
  .ring{position:absolute; inset:11.5%; border-radius:50%;
    border:12px solid rgba(20,35,82,.12); z-index:2;}

  .hashes{position:absolute; inset:12.5%; border-radius:50%; z-index:3; pointer-events:none;}
  .tick{position:absolute; left:50%; top:50%; width:2px; height:13%;
    background:var(--tick); transform-origin:50% 0%; opacity:.95;}
  .tick.major{width:4px; height:15%; background:#9fb0ff}

  .cardinals{position:absolute; inset:0; z-index:5; pointer-events:none;}
  .cardinals .lbl{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    font-weight:900; letter-spacing:.5px; color:#0a1b4d;
    text-shadow:0 1px 0 #fff8, 0 0 12px #fff8;
    padding:4px 8px; border-radius:10px; background:rgba(255,255,255,.65);
    border:1px solid rgba(14,24,60,.1);
  }
  .cardinals .N{top:5.5%;  font-size:20px}
  .cardinals .S{top:94.5%; font-size:18px}
  .cardinals .E{left:94.5%; font-size:18px}
  .cardinals .W{left:5.5%;  font-size:18px}

  .needle{position:absolute; left:50%; top:50%; width:80%; height:80%;
    transform:translate(-50%,-50%) rotate(0deg); transform-origin:50% 50%;
    z-index:6; pointer-events:none;}
  .needle .arrow{
    position:absolute; left:50%; top:8%; transform:translateX(-50%);
    width:0; height:0; border-left:22px solid transparent; border-right:22px solid transparent;
    border-bottom:36px solid var(--gold3); filter: drop-shadow(0 4px 6px rgba(0,0,0,.25));
  }
  .needle .shaft{
    position:absolute; left:50%; top:12%; transform:translateX(-50%);
    width:12px; height:46%; background:linear-gradient(180deg, var(--gold1), var(--gold2));
    border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,.25);
  }
  .hub-center{
    position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
    width:58px; height:58px; border-radius:50%;
    background: radial-gradient(circle at 35% 35%, var(--gold1) 0 40%, var(--gold2) 70%);
    box-shadow: inset 0 -8px 14px rgba(0,0,0,.15), 0 8px 18px rgba(0,0,0,.22);
    border:3px solid #fff; z-index:7; pointer-events:none;
  }
  .kaaba{
    position:absolute; left:50%; top:14%;
    transform:translate(-50%,-50%);
    width:32px; height:32px; border-radius:8px;
    background: linear-gradient(135deg, #2b2b2b 63%, #ffd23c 63%) no-repeat, linear-gradient(#111, #333);
    box-shadow: 0 10px 20px rgba(0,0,0,.35); z-index:4;
  }

  .caption{margin-top:8px; text-align:center; line-height:1.35}
  .hint{font-size:14px; color:var(--muted)}
  .ok{color:var(--ok); font-weight:800}

  .panel{
    margin-top:10px; padding:10px 14px; border-radius:12px;
    background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
    font-size:13px; text-align:center; backdrop-filter: blur(6px);
    max-width:min(92vw,560px);
  }
  .panel b{color:var(--gold1)}
  footer{margin-top:auto; padding:16px; font-size:12px; color:var(--muted); text-align:center}
</style>
</head>
<body>
  <header>
    <h1>Компас Киблы</h1>
    <button id="startBtn" class="btn">Start</button>
    <button id="enableMotionBtn" class="btn" title="Повторить запрос к датчикам">Разрешить ориентацию</button>
    <div id="status"></div>
  </header>

  <div class="dial-wrap" aria-label="Компас">
    <div class="rim"></div>
    <div class="face"></div>
    <div class="ring"></div>
    <div class="hashes" id="hashes"></div>

    <div class="cardinals" aria-hidden="true">
      <div class="lbl N">N</div><div class="lbl E">E</div>
      <div class="lbl S">S</div><div class="lbl W">W</div>
    </div>

    <div id="needle" class="needle" aria-hidden="true">
      <div class="arrow"></div><div class="shaft"></div>
    </div>

    <div class="hub-center" aria-hidden="true"></div>
    <div class="kaaba" title="Кибла"></div>
  </div>

  <div class="caption">
    <div id="msgMain">Нажмите <b>Start</b> и разрешите доступ к геопозиции и ориентации</div>
    <div class="hint">Держите устройство параллельно земле</div>
  </div>

  <div class="panel" id="readout" hidden>
    Азимут на Киблу: <b id="brng">—°</b> • Ваш курс: <b id="head">—°</b>
  </div>

  <footer>Если стрелка не двигается — у устройства нет компаса или браузер запретил датчики. На iOS подтвердите «Доступ к движению и ориентации».</footer>

<script>
(function () {
  const EL = s => document.querySelector(s);
  const statusEl = EL('#status');
  const msgMain  = EL('#msgMain');
  const startBtn = EL('#startBtn');
  const enableBtn= EL('#enableMotionBtn');
  const needle   = EL('#needle');
  const readout  = EL('#readout');
  const brngEl   = EL('#brng');
  const headEl   = EL('#head');

  // деления каждые 10°, утолщённые на 0/90/180/270
  const hashes = document.getElementById('hashes');
  for (let i=0;i<36;i++){
    const d = document.createElement('div');
    d.className = 'tick';
    if (i%9===0) d.classList.add('major');
    d.style.transform = `translate(-50%,-50%) rotate(${i*10}deg) translateY(-43%)`;
    hashes.appendChild(d);
  }

  const KAABA = { lat: 21.422487, lon: 39.826206 };
  let user = { lat: null, lon: null };
  let qiblaBearing = null;      // истинный азимут на Каабу
  let lastHeading = null;       // курс устройства
  const norm = a => (a%360+360)%360;
  const toRad = d => d * Math.PI / 180;
  const toDeg = r => r * 180 / Math.PI;

  function bearingTo(lat1, lon1, lat2, lon2) {
    const φ1 = toRad(lat1), φ2 = toRad(lat2), Δλ = toRad(lon2 - lon1);
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    return norm(toDeg(Math.atan2(y, x)));
  }

  function updateNeedle(){
    if (qiblaBearing==null || lastHeading==null) return;
    // «вправо — вправо»: поворот иглы = qibla - heading
    const rel = norm(qiblaBearing - lastHeading);
    needle.style.transform = `translate(-50%,-50%) rotate(${rel}deg)`;
    brngEl.textContent = `${Math.round(qiblaBearing)}°`;
    headEl.textContent = `${Math.round(lastHeading)}°`;
    readout.hidden = false;

    const diff = Math.min(rel, 360-rel);
    if (diff < 8) {
      msgMain.innerHTML = '<span class="ok">Вы нашли Киблу</span><br/><span style="opacity:.9">You\'ve found Qibla</span>';
    } else if (diff < 20) {
      msgMain.innerHTML = 'Почти у цели<br/><span style="opacity:.9">Almost there</span>';
    } else {
      msgMain.textContent = 'Вращайте устройство, пока стрелка не совпадёт с меткой';
    }
  }

  // ── iOS: просим разрешение НА СЕНСОРЫ в контексте клика
  async function enableOrientationPermission() {
    let granted = true;

    // Для iOS 13+ (Safari / WebView)
    if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
      const state = await DeviceOrientationEvent.requestPermission();
      granted = (state === 'granted');
    }
    // Иногда требуется и для Motion (не всегда, но попробуем мягко)
    if (granted && window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
      try {
        const state2 = await DeviceMotionEvent.requestPermission();
        granted = granted && (state2 === 'granted');
      } catch { /* игнорируем */ }
    }
    if (!granted) throw new Error('orientation-denied');
    // Подписываемся на события
    window.addEventListener('deviceorientation', onOrient, true);
    statusEl.textContent = 'Ориентация: OK';
    return true;
  }

  function onOrient(e){
    let heading = null;
    if (typeof e.webkitCompassHeading === 'number') {
      // iOS: истинный курс (0 = север, растёт по часовой)
      heading = e.webkitCompassHeading;
    } else if (typeof e.alpha === 'number') {
      // Android: используем 360 - alpha, чтобы убрать «зеркальность»
      heading = 360 - e.alpha;
    }
    if (heading != null) {
      lastHeading = norm(heading);
      updateNeedle();
    }
  }

  function askGeolocation() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) {
        statusEl.textContent = 'Геолокация недоступна в браузере';
        return resolve(false);
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          user.lat = pos.coords.latitude;
          user.lon = pos.coords.longitude;
          qiblaBearing = bearingTo(user.lat, user.lon, KAABA.lat, KAABA.lon);
          statusEl.textContent = `Гео: ${user.lat.toFixed(4)}, ${user.lon.toFixed(4)} • Азимут: ${Math.round(qiblaBearing)}°`;
          updateNeedle();
          resolve(true);
        },
        err => { statusEl.textContent = 'Не удалось получить геопозицию: ' + err.message; resolve(false); },
        { enableHighAccuracy:true, timeout:15000, maximumAge:0 }
      );
    });
  }

  // ── Кнопки
  startBtn.addEventListener('click', async () => {
    startBtn.disabled = true;
    msgMain.textContent = 'Запрашиваю доступ к датчикам…';
    try {
      // ВАЖНО: запрашиваем PERMISSION СРАЗУ В КЛИКЕ (без промежуточных await)
      await enableOrientationPermission();
      msgMain.textContent = 'Запрашиваю геопозицию…';
      // Гео можно уже ждать отдельно — контекст жеста не нужен
      await askGeolocation();
      msgMain.textContent = 'Вращайте устройство, пока стрелка не совпадёт с меткой';
      enableBtn.style.display = 'none';
    } catch (e) {
      // Если ориентацию не дали — показываем кнопку повтора запроса
      msgMain.textContent = 'Нужно разрешить доступ к ориентации устройства.';
      enableBtn.style.display = 'inline-block';
      startBtn.disabled = false;
    }
  });

  enableBtn.addEventListener('click', async () => {
    // Повторная попытка запроса — тоже в клике пользователя
    try {
      await enableOrientationPermission();
      enableBtn.style.display = 'none';
      msgMain.textContent = 'Запрашиваю геопозицию…';
      await askGeolocation();
      msgMain.textContent = 'Вращайте устройство, пока стрелка не совпадёт с меткой';
    } catch {
      msgMain.textContent = 'Ориентация всё ещё не разрешена. Откройте Настройки → Safari → Motion & Orientation Access.';
    }
  });
})();
</script>
</body>
</html>

